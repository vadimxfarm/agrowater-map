<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgroWater ‚Äî –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –ø–æ–ª–µ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    #map { height: 70vh; margin-top: 10px; }
    .form-group { margin: 10px 0; }
    input, select, button { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
    #status { color: green; margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üó∫Ô∏è –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –ø–æ–ª–µ</h2>

  <div class="form-group">
    <label>–ù–∞–∑–≤–∞ –ø–æ–ª—è:</label>
    <input type="text" id="fieldName" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ü–æ–ª–µ 1" />
  </div>

  <div class="form-group">
    <label>–ö—É–ª—å—Ç—É—Ä–∞:</label>
    <select id="crop">
      <option value="–ø—à–µ–Ω–∏—Ü—è">–ü—à–µ–Ω–∏—Ü—è</option>
      <option value="–∫—É–∫—É—Ä—É–¥–∑–∞">–ö—É–∫—É—Ä—É–¥–∑–∞</option>
      <option value="—Å–æ–Ω—è—à–Ω–∏–∫">–°–æ–Ω—è—à–Ω–∏–∫</option>
      <option value="—è—á–º—ñ–Ω—å">–Ø—á–º—ñ–Ω—å</option>
      <option value="–≤–∏–Ω–æ–≥—Ä–∞–¥">–í–∏–Ω–æ–≥—Ä–∞–¥</option>
    </select>
  </div>

  <div id="map"></div>
  <button onclick="saveField()">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–ª–µ</button>
  <p id="status"></p>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet.geometryutil@0.10.0/src/leaflet.geometryutil.js"></script>

  <script>
    // –û—Ç—Ä–∏–º—É—î–º–æ user_id –∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id') || 'test';

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–∞—Ä—Ç—É (–ö–∏—ó–≤ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
    const map = L.map('map').setView([50.45, 30.52], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // –ì—Ä—É–ø–∞ –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // –ö–æ–Ω—Ç—Ä–æ–ª –º–∞–ª—é–≤–∞–Ω–Ω—è
    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: true,
        polyline: false,
        rectangle: false,
        circle: false,
        marker: false,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    let drawnPolygon = null;

    map.on(L.Draw.Event.CREATED, function (e) {
      if (drawnPolygon) drawnItems.removeLayer(drawnPolygon);
      drawnPolygon = e.layer;
      drawnItems.addLayer(drawnPolygon);
    });

    // –§—É–Ω–∫—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
    async function saveField() {
      if (!drawnPolygon) {
        alert("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞–º–∞–ª—é–π—Ç–µ –ø–æ–ª–µ!");
        return;
      }

      const name = document.getElementById('fieldName').value || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
      const crop = document.getElementById('crop').value;
      const coords = drawnPolygon.getLatLngs()[0].map(p => [p.lat, p.lng]);

      // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø–ª–æ—â—ñ –≤ –≥–µ–∫—Ç–∞—Ä–∞—Ö
      const areaHa = (L.GeometryUtil.geodesicArea(drawnPolygon.getLatLngs()[0]) / 10000).toFixed(2);

      // üî¥ –ó–ê–ú–Ü–ù–ò –¶–ï–ô URL –ù–ê –°–í–Ü–ô Google Apps Script!
      const scriptUrl = "https://script.google.com/macros/s/AKfycbyQ4-oY0El3CnPYPV-c6trH8fc1UYxjeGpz8j3BwkMdo8gZ3EGbFmTnCMQnTNIM3UOp5Q/exec";

      try {
        const response = await fetch(scriptUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            field_name: name,
            crop: crop,
            area_ha: areaHa,
            polygon: JSON.stringify(coords)
          })
        });

        if (response.ok) {
          document.getElementById('status').innerText = "‚úÖ –ü–æ–ª–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ! –ü–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –≤ Telegram.";
        } else {
          throw new Error("–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
        }
      } catch (e) {
        alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –∞–±–æ URL —Å–∫—Ä–∏–ø—Ç–∞.");
        console.error(e);
      }
    }
  </script>
</body>
</html>
