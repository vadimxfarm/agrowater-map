<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AgroWater ‚Äî –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –ø–æ–ª–µ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    #map { height: 80vh; }
    body { margin: 0; padding: 10px; font-family: Arial; }
    .form-group { margin: 10px 0; }
    input, select, button { padding: 8px; width: 100%; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>üó∫Ô∏è –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –ø–æ–ª–µ</h2>
  
  <div class="form-group">
    <label>–ù–∞–∑–≤–∞ –ø–æ–ª—è:</label>
    <input type="text" id="fieldName" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ü–æ–ª–µ 1">
  </div>
  
  <div class="form-group">
    <label>–ö—É–ª—å—Ç—É—Ä–∞:</label>
    <select id="crop">
      <option value="–ø—à–µ–Ω–∏—Ü—è">–ü—à–µ–Ω–∏—Ü—è</option>
      <option value="–∫—É–∫—É—Ä—É–¥–∑–∞">–ö—É–∫—É—Ä—É–¥–∑–∞</option>
      <option value="—Å–æ–Ω—è—à–Ω–∏–∫">–°–æ–Ω—è—à–Ω–∏–∫</option>
      <option value="—è—á–º—ñ–Ω—å">–Ø—á–º—ñ–Ω—å</option>
    </select>
  </div>

  <div id="map"></div>
  
  <button onclick="saveField()">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–ª–µ</button>
  <p id="status" style="color:green; margin-top:10px;"></p>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script>
    // –û—Ç—Ä–∏–º—É—î–º–æ user_id –∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id') || 'test';

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–∞—Ä—Ç—É
    const map = L.map('map').setView([50.45, 30.52], 10); // –ö–∏—ó–≤ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // –î–æ–¥–∞—î–º–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∞–ª—é–≤–∞–Ω–Ω—è
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: true,
        polyline: false,
        rectangle: false,
        circle: false,
        marker: false,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    let drawnPolygon = null;

    map.on(L.Draw.Event.CREATED, function (e) {
      if (drawnPolygon) {
        drawnItems.removeLayer(drawnPolygon);
      }
      drawnPolygon = e.layer;
      drawnItems.addLayer(drawnPolygon);
    });

    // –§—É–Ω–∫—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
    async function saveField() {
      if (!drawnPolygon) {
        alert("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞–º–∞–ª—é–π—Ç–µ –ø–æ–ª–µ!");
        return;
      }
      const name = document.getElementById('fieldName').value || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
      const crop = document.getElementById('crop').value;
      const coords = drawnPolygon.getLatLngs()[0].map(p => [p.lat, p.lng]);

      // –†–∞—Ö—É—î–º–æ –ø–ª–æ—â—É (–≥—Ä—É–±–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫)
      const areaHa = (L.GeometryUtil.geodesicArea(drawnPolygon.getLatLngs()[0]) / 10000).toFixed(2);

      // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –¥–∞–Ω—ñ –Ω–∞ Google Apps Script (–Ω–∞–ª–∞—à—Ç—É—î–º–æ –∑–∞–≤—Ç—Ä–∞)
      const scriptUrl = "https://script.google.com/macros/s/AKfycbyV220nKc5xj2Zn7yZq75TYzZyAUO1Qp6c7QQxsMJ5SYB530UmZDT1WifAkscxBSOadHQ/exec"; // ‚Üê —Å—é–¥–∏ –≤—Å—Ç–∞–≤–∏—à –∑–∞–≤—Ç—Ä–∞

      const data = {
        user_id: userId,
        field_name: name,
        crop: crop,
        area_ha: areaHa,
        polygon: JSON.stringify(coords)
      };

      try {
        const res = await fetch(scriptUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          document.getElementById('status').innerText = "‚úÖ –ü–æ–ª–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ! –ü–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –≤ Telegram.";
        } else {
          throw new Error("–ü–æ–º–∏–ª–∫–∞");
        }
      } catch (e) {
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è.");
      }
    }
  </script>
</body>
</html>
